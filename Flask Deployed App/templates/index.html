{% extends 'base.html' %}
{% block pagetitle %}AI Engine â€” PlantGuard AI{% endblock %}

{% block body %}
<div class="page-wrapper">

    <section class="section-header" style="margin-bottom:2rem;">
        <div class="section-badge animate-in">ğŸ”¬ AI Engine</div>
        <h1 class="section-title animate-in" style="animation-delay:0.1s;">
            Upload & <span class="gradient-text">Diagnose</span>
        </h1>
        <p class="section-subtitle animate-in" style="animation-delay:0.2s;">
            Upload a clear image of a plant leaf and let our AI detect diseases in seconds.
        </p>
    </section>

    <div class="info-columns" style="grid-template-columns:1fr 1.2fr 1fr;">

        <!-- Left: Why detect? -->
        <div class="glass-card animate-in">
            <div class="result-section-title"><span class="icon">ğŸ”</span> Why Detect Early?</div>
            <p class="result-text">
                Plant diseases affect growth and yield significantly. Early detection prevents crop loss,
                saves money on treatments, and ensures healthy produce. Without proper identification,
                control measures can be ineffective â€” or worse, harmful.
            </p>
        </div>

        <!-- Center: Upload -->
        <div class="glass-card animate-in" style="animation-delay:0.15s;">
            <form action="/submit" method="POST" enctype="multipart/form-data" id="upload-form">

                <!-- Upload Zone -->
                <div class="upload-zone" id="drop-zone" onclick="document.getElementById('actual-btn').click();">
                    <span class="upload-icon">ğŸŒ¿</span>
                    <div class="upload-text">Drop your leaf image here</div>
                    <div class="upload-hint">or click to browse &nbsp;Â·&nbsp; JPG, PNG, WEBP</div>
                    <input type="file" id="actual-btn" name="image" accept="image/*" hidden>
                </div>

                <!-- File name display -->
                <div class="file-name-display" id="file-chosen">
                    <span>ğŸ“</span> <span id="file-name-text">No file chosen</span>
                </div>

                <!-- Camera -->
                <div style="display:flex;gap:0.75rem;margin-top:1.5rem;flex-wrap:wrap;justify-content:center;">
                    <button type="button" class="btn-secondary-outline" id="camera-btn">ğŸ“· Open Camera</button>
                    <button type="submit" class="btn-primary-glow" id="submit-btn" disabled>ğŸ”¬ Analyze Leaf</button>
                </div>

                <!-- Camera Container -->
                <div class="camera-container" id="camera-container">
                    <video id="camera-feed" autoplay playsinline></video>
                    <div style="padding:0.75rem;text-align:center;">
                        <button type="button" class="btn-primary-glow" id="capture-btn"
                            style="font-size:0.85rem;padding:0.6rem 1.5rem;">ğŸ“¸ Capture</button>
                    </div>
                </div>

                <!-- Preview -->
                <img id="preview" class="preview-image" alt="Preview">

            </form>
        </div>

        <!-- Right: Prevention -->
        <div class="glass-card animate-in" style="animation-delay:0.25s;">
            <div class="result-section-title"><span class="icon">ğŸ›¡ï¸</span> Prevention Tips</div>
            <ol style="color:var(--text-secondary);font-size:0.92rem;line-height:2;padding-left:1.2rem;">
                <li>Follow good sanitation practices</li>
                <li>Fertilize to keep plants healthy</li>
                <li>Inspect plants before purchase</li>
                <li>Let soil warm before planting</li>
                <li>Rotate crops every season</li>
                <li>Ensure good air circulation</li>
                <li>Remove diseased foliage promptly</li>
            </ol>
            <div style="margin-top:1rem;">
                <a href="https://www.thespruce.com/prevent-plant-diseases-in-your-garden-2539511" target="_blank"
                    class="btn-secondary-outline" style="font-size:0.82rem;padding:0.5rem 1rem;">Learn More â†’</a>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const fileInput = document.getElementById('actual-btn');
    const fileChosen = document.getElementById('file-chosen');
    const fileNameTxt = document.getElementById('file-name-text');
    const submitBtn = document.getElementById('submit-btn');
    const dropZone = document.getElementById('drop-zone');
    const preview = document.getElementById('preview');
    const cameraBtn = document.getElementById('camera-btn');
    const cameraWrap = document.getElementById('camera-container');
    const cameraFeed = document.getElementById('camera-feed');
    const captureBtn = document.getElementById('capture-btn');

    let capturedFile = null;

    // File input change
    fileInput.addEventListener('change', function () {
        if (this.files.length) {
            fileNameTxt.textContent = this.files[0].name;
            fileChosen.classList.add('visible');
            submitBtn.disabled = false;
            showPreview(this.files[0]);
        }
    });

    // Drag & Drop
    ['dragenter', 'dragover'].forEach(e => {
        dropZone.addEventListener(e, ev => { ev.preventDefault(); dropZone.classList.add('drag-over'); });
    });
    ['dragleave', 'drop'].forEach(e => {
        dropZone.addEventListener(e, ev => { ev.preventDefault(); dropZone.classList.remove('drag-over'); });
    });
    dropZone.addEventListener('drop', ev => {
        const files = ev.dataTransfer.files;
        if (files.length) {
            fileInput.files = files;
            fileInput.dispatchEvent(new Event('change'));
        }
    });

    function showPreview(file) {
        const reader = new FileReader();
        reader.onload = e => { preview.src = e.target.result; preview.classList.add('visible'); };
        reader.readAsDataURL(file);
    }

    // Camera
    cameraBtn.addEventListener('click', () => {
        cameraWrap.classList.toggle('active');
        if (cameraWrap.classList.contains('active')) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => { cameraFeed.srcObject = stream; })
                .catch(err => console.error('Camera error:', err));
        } else {
            if (cameraFeed.srcObject) cameraFeed.srcObject.getTracks().forEach(t => t.stop());
        }
    });

    captureBtn.addEventListener('click', () => {
        const canvas = document.createElement('canvas');
        canvas.width = cameraFeed.videoWidth;
        canvas.height = cameraFeed.videoHeight;
        canvas.getContext('2d').drawImage(cameraFeed, 0, 0);
        const dataUrl = canvas.toDataURL('image/jpeg');

        // Show preview
        preview.src = dataUrl;
        preview.classList.add('visible');

        // Convert to file
        const blob = dataURItoBlob(dataUrl);
        capturedFile = new File([blob], 'camera_capture.jpg', { type: 'image/jpeg' });
        const dt = new DataTransfer();
        dt.items.add(capturedFile);
        fileInput.files = dt.files;

        fileNameTxt.textContent = 'camera_capture.jpg';
        fileChosen.classList.add('visible');
        submitBtn.disabled = false;

        // Stop camera
        if (cameraFeed.srcObject) cameraFeed.srcObject.getTracks().forEach(t => t.stop());
        cameraWrap.classList.remove('active');
    });

    function dataURItoBlob(dataURI) {
        const bytes = atob(dataURI.split(',')[1]);
        const buf = new Uint8Array(bytes.length);
        for (let i = 0; i < bytes.length; i++) buf[i] = bytes.charCodeAt(i);
        return new Blob([buf], { type: 'image/jpeg' });
    }
</script>
{% endblock %}